<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工程階層結算系統</title>
    <style>
        :root {
            --bg: #F7F6F2;
            --card: #FFFFFF;
            --primary: #8E9775;
            --accent: #AF8F6F;
            --text: #4A4A4A;
            --border: #E0DED7;
            --danger: #e74c3c;
            --success: #217346;
            --info: #5da9ad;
            --dark: #2c3e50;
        }

        body { background-color: var(--bg); color: var(--text); font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; width: 100%; max-width: 500px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #E0DED7; cursor: pointer; border-radius: 8px 8px 0 0; color: #777; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .page { display: none; width: 100%; max-width: 500px; animation: fadeIn 0.3s; }
        #listPage.page.active { display: block; width: 98vw; max-width: none; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); width: 100%; padding: 25px; border-radius: 0 0 15px 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); box-sizing: border-box; margin-bottom: 20px; }
        .list-card { background: var(--card); width: 100%; padding: 25px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); box-sizing: border-box; }
        
        h2 { text-align: center; color: var(--primary); font-weight: 500; margin-bottom: 20px; letter-spacing: 1px; }
        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; display: flex; flex-direction: column; }
        
        label { font-size: 0.8rem; margin-bottom: 5px; color: #999; }
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; outline: none; background: #FAFAFA; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary); background: #FFF; }
        
        .select-group { display: flex; background: #EEE; padding: 4px; border-radius: 8px; gap: 2px; }
        .select-item { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 0.9rem; color: #777; transition: 0.2s; background: transparent; border: none; }
        .select-item.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        #netAmount { font-weight: bold; color: var(--accent); background-color: #FFF9F3; border: 1px solid var(--accent); }
        .config-box { background: #F9F9F8; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #EEE; }
        .payment-box { border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 20px; }
        
        .input-with-unit { position: relative; display: flex; align-items: center; }
        .unit-label { margin-left: 5px; font-size: 0.8rem; color: #999; white-space: nowrap; width: 20px; }

        .display-area { background: #FCFCFB; border: 1px solid #EEE; padding: 20px; border-radius: 10px; margin-top: 20px; min-height: 50px; }
        .section-title { font-size: 0.85rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .formula { font-size: 0.9rem; margin-bottom: 12px; line-height: 1.6; color: #666; }
        .formula strong { color: #333; font-weight: 600; }
        .subtotal-line { background: #F0F2EB; padding: 4px 8px; border-radius: 4px; color: var(--primary) !important; }
        
        .payment-result { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #DDD; }
        .date-line { font-family: monospace; font-weight: bold; font-size: 1.1rem; color: var(--accent); margin-bottom: 5px; }

        .btn-save { width: 100%; padding: 12px; margin-top: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-excel { padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        .btn-info { padding: 10px 20px; background: var(--info); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        .btn-reset { width: 100%; padding: 10px; margin-top: 10px; color: #BBB; border: 1px solid #EEE; background: none; cursor: pointer; border-radius: 8px; font-size: 0.8rem; }
        
        .check-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .check-label input[type="checkbox"] { width: auto; margin: 0; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; overflow: hidden; }
        
        #recordTable td { text-overflow: clip; white-space: nowrap; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        #recordTable td::-webkit-scrollbar { display: none; }
        
        th { background-color: #f8f8f8; color: var(--primary); }
        .sortable { cursor: pointer; user-select: none; position: relative; }
        .sortable:hover { background-color: #f0f0f0; }
        
        .editable { cursor: pointer; background-color: #fffdec; border-radius: 4px; padding: 2px 5px; display: block; width: calc(100% - 10px); min-height: 1.2em; border: 1px transparent solid; }
        .editable:focus { border-color: var(--accent); outline: none; background-color: #fff; }
        
        .amount-cell { text-align: right; font-family: monospace; }
        .action-cell { text-align: center; width: 90px; }
        .btn-del { color: var(--danger); border: none; background: none; cursor: pointer; font-weight: bold; font-size: 1.2rem; line-height: 1; vertical-align: middle; }
        
        .filter-row { margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; justify-content: space-between; }
        .filter-group { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; right: 15px; top: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }

        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; z-index: 100; max-height: 250px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; line-height: 1.4; }
        .search-item:hover { background: #f8f8f8; color: var(--primary); }

        .vendor-form { background: #F9F9F8; padding: 15px; border-radius: 10px; border: 1px solid #EEE; margin-bottom: 20px; }
        .summary-bar { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: right; font-size: 1.1rem; color: var(--dark); border: 1px solid #eee; }
        .summary-bar strong { color: var(--danger); font-size: 1.3rem; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchPage('calcPage', this)">計算工具</button>
    <button class="tab-btn" onclick="switchPage('listPage', this)">付款清單</button>
    <button class="tab-btn" onclick="switchPage('vendorPage', this)">廠商資料</button>
</div>

<div id="calcPage" class="page active">
    <div class="card">
        <h2>工程結算明細</h2>
        <div class="row">
            <div class="col">
                <label>付款公司</label>
                <select id="companySelect">
                    <option value="瀞川">瀞川</option>
                    <option value="聿川">聿川</option>
                    <option value="長川">長川</option>
                    <option value="上川">上川</option>
                </select>
            </div>
            <div class="col" style="position: relative;">
                <label>搜尋廠商 (預覽包含帳號)</label>
                <input type="text" id="vendorSearch" placeholder="搜尋廠商關鍵字..." oninput="searchVendor(this.value)">
                <div id="searchResults" class="search-results"></div>
                <input type="hidden" id="tempBankCode">
                <input type="hidden" id="tempAccount">
                <input type="hidden" id="tempOwner">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>工程內容 (明細)</label>
                <input type="text" id="workNote" placeholder="例如：木地板已完成54戶請款">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>憑證類型</label>
                <div class="select-group" id="invTypeGroup">
                    <button class="select-item active" onclick="setSelect('invType', '發票')">發票</button>
                    <button class="select-item" onclick="setSelect('invType', '收據')">收據</button>
                </div>
                <input type="hidden" id="invoiceType" value="發票">
            </div>
            <div class="col" id="taxModeCol">
                <label>計算基準</label>
                <div class="select-group" id="taxModeGroup">
                    <button class="select-item active" onclick="setSelect('taxMode', '未稅')">未稅額</button>
                    <button class="select-item" onclick="setSelect('taxMode', '含稅')">含稅額</button>
                </div>
                <input type="hidden" id="taxMode" value="未稅">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label id="rawAmountLabel">金額 (未稅)</label>
                <input type="number" id="rawAmount" placeholder="請輸入金額" oninput="calculate(false, false)">
            </div>
            <div class="col" id="taxInputCol">
                <label>稅額 (5%)</label>
                <input type="number" id="taxAmount" oninput="calculate(true, false)">
            </div>
        </div>

        <div class="config-box">
            <div class="row">
                <div class="col">
                    <label class="check-label"><input type="checkbox" id="cleanCheck" checked onchange="calculate(false, false)"> 清潔保險 (%)</label>
                    <input type="number" id="cleanRate" value="0.5" step="0.1" oninput="calculate(false, false)">
                </div>
                <div class="col">
                    <label class="check-label"><input type="checkbox" id="retentionCheck" checked onchange="calculate(false, false)"> 保留款 (%)</label>
                    <input type="number" id="retentionRate" value="10" step="1" oninput="calculate(false, false)">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>保留款金額 (可手動修改)</label>
                    <input type="number" id="retentionAmount" oninput="calculate(true, true)">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>加扣款事由</label>
                <input type="text" id="adjustmentNote" placeholder="例如：代購材料扣款" oninput="calculate(false, false)">
            </div>
            <div class="col">
                <label>加扣款金額</label>
                <input type="number" id="adjustmentAmount" placeholder="0" oninput="calculate(false, false)">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>最終淨額 (可手動修改)</label>
                <input type="number" id="netAmount" oninput="updateFormulaOnly()">
            </div>
        </div>

        <div class="payment-box">
            <div class="row">
                <div class="col">
                    <label>付款基準日 (格式: 1150212)</label>
                    <input type="text" id="baseDate" placeholder="例如: 1150212" oninput="renderDetail()">
                </div>
            </div>
            <label>付款比例 / 期數 (月)</label>
            <div class="row">
                <div class="col"><div class="input-with-unit"><input type="number" id="p1Pct" placeholder="比例" oninput="renderDetail()"><span class="unit-label">%</span></div></div>
                <div class="col"><div class="input-with-unit"><input type="number" id="p1Mon" placeholder="期數" oninput="renderDetail()"><span class="unit-label">月</span></div></div>
            </div>
            <div class="row">
                <div class="col"><div class="input-with-unit"><input type="number" id="p2Pct" placeholder="比例" oninput="renderDetail()"><span class="unit-label">%</span></div></div>
                <div class="col"><div class="input-with-unit"><input type="number" id="p2Mon" placeholder="期數" oninput="renderDetail()"><span class="unit-label">月</span></div></div>
            </div>
        </div>

        <div class="display-area">
            <div class="section-title">階層計算列示</div>
            <div id="processFormula" class="formula">請輸入資料...</div>
            <div class="payment-result" id="paymentDetail"></div>
        </div>

        <button class="btn-save" onclick="saveData()">儲存此筆排程</button>
        <button class="btn-reset" onclick="location.reload()">重新整理</button>
    </div>
</div>

<div id="listPage" class="page">
    <div class="list-card">
        <div class="section-title">付款清單明細</div>
        <div class="filter-row">
            <div class="filter-group">
                <label style="margin:0">資料月份：</label>
                <select id="filterMonth" style="width: auto; padding: 5px;" onchange="renderTable()"></select>
                <label style="margin:0; margin-left:10px;">篩選公司：</label>
                <select id="filterCompany" style="width: auto; padding: 5px;" onchange="renderTable()">
                    <option value="全部">全部顯示</option>
                    <option value="瀞川">瀞川</option>
                    <option value="聿川">聿川</option>
                    <option value="長川">長川</option>
                    <option value="上川">上川</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn-info" onclick="autoFillRecordsByOwner()">按戶名補齊資料</button>
                <button class="btn-info" style="background: var(--danger); border-color: var(--danger);" onclick="clearData()">清空所有排程</button>
                <button class="btn-info" style="background: var(--dark);" onclick="exportBankExcel()">匯出匯款資料</button>
                <button class="btn-excel" onclick="exportClaimExcel()">匯出請款明細</button>
            </div>
        </div>
        <table id="recordTable">
            <thead>
                <tr>
                    <th style="width: 30px; text-align: center;"><input type="checkbox" id="selectAll" checked onclick="toggleSelectAll(this)"></th>
                    <th style="width: 35px;">No.</th>
                    <th style="width: 8.5ch;">日期</th>
                    <th style="width: auto;" class="sortable" onclick="toggleSort('desc')">明細內容</th>
                    <th style="width: 90px;">金額</th>
                    <th style="width: 8.5ch;">解款行</th>
                    <th style="width: 17ch;">帳號</th>
                    <th style="width: 20em;">戶名</th>
                    <th style="width: 3.2em;">付款公司</th>
                    <th class="action-cell">功能</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="summary-bar" id="listSummary">
            篩選總金額：<span id="filteredTotal">$0</span> | 勾選總金額：<strong id="checkedTotal">$0</strong>
        </div>
    </div>
</div>

<div id="vendorPage" class="page" style="max-width: 850px;">
    <div class="list-card">
        <div class="section-title">廠商匯款資料管理</div>
        <div class="vendor-form">
            <div class="section-title" style="border-left: 3px solid var(--accent); color: var(--accent);">手動新增廠商</div>
            <div class="row">
                <div class="col"><label>廠商名稱</label><input type="text" id="newVName" placeholder="公司名"></div>
                <div class="col"><label>解款行</label><input type="text" id="newVBank" placeholder="代號+名稱"></div>
            </div>
            <div class="row">
                <div class="col"><label>收款帳號</label><input type="text" id="newVAcc" placeholder="銀行帳號"></div>
                <div class="col"><label>收款戶名</label><input type="text" id="newVOwner" placeholder="戶名"></div>
            </div>
            <button class="btn-save" style="margin-top: 5px; background: var(--accent);" onclick="manualAddVendor()">新增廠商資料</button>
        </div>
        <table id="vendorTable">
            <thead>
                <tr>
                    <th style="width: 25%;">廠商名稱</th>
                    <th style="width: 20%;">解款行</th>
                    <th style="width: 20%;">帳號</th>
                    <th style="width: 20%;">戶名</th>
                    <th class="action-cell">功能</th>
                </tr>
            </thead>
            <tbody id="vendorTableBody"></tbody>
        </table>
    </div>
</div>

<div id="infoModal" class="modal" onclick="document.getElementById('infoModal').style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="document.getElementById('infoModal').style.display='none'">&times;</span>
        <div class="section-title">計算過程紀錄</div>
        <div id="modalBody" class="formula"></div>
    </div>
</div>

<script>
    const fmt = new Intl.NumberFormat('zh-TW');
    let db = JSON.parse(localStorage.getItem('paymentRecords')) || [];
    let vendors = JSON.parse(localStorage.getItem('vendorList')) || [];
    let lastSelection = JSON.parse(localStorage.getItem('lastSelection')) || { invType: '發票', taxMode: '未稅' };
    
    let currentSortOrder = 'asc';
    let checkedIds = new Set();
    let lastCalcState = { raw: 0, tax: 0, total: 0, cRate: 0, cleanFee: 0, subtotal: 0, rRate: 0, retention: 0, adj: 0, adjNote: "" };

    function setSelect(type, value) {
        const input = document.getElementById(type === 'invType' ? 'invoiceType' : 'taxMode');
        input.value = value;
        const groupIdx = type === 'invType' ? 'invTypeGroup' : 'taxModeGroup';
        const btns = document.getElementById(groupIdx).getElementsByTagName('button');
        for (let btn of btns) {
            btn.classList.toggle('active', btn.innerText === value || (value === '未稅' && btn.innerText === '未稅額') || (value === '含稅' && btn.innerText === '含稅額'));
        }
        lastSelection[type] = value;
        localStorage.setItem('lastSelection', JSON.stringify(lastSelection));
        calculate(false, false);
    }

    function calculate(isManualTax, isManualRetention) {
        const invType = document.getElementById('invoiceType').value;
        const taxMode = document.getElementById('taxMode').value;
        const inputAmount = parseFloat(document.getElementById('rawAmount').value) || 0;
        const taxInput = document.getElementById('taxAmount');
        const taxModeCol = document.getElementById('taxModeCol');
        const taxInputCol = document.getElementById('taxInputCol');
        const retentionInput = document.getElementById('retentionAmount');
        const adj = parseFloat(document.getElementById('adjustmentAmount').value) || 0;
        const adjNote = document.getElementById('adjustmentNote').value || "加扣款";
        
        let raw = 0;
        let tax = 0;

        if (invType === '收據') {
            taxModeCol.style.visibility = 'hidden';
            taxInputCol.style.visibility = 'hidden';
            taxInput.value = "";
            raw = inputAmount;
            tax = 0;
            document.getElementById('rawAmountLabel').innerText = "金額 (收據)";
        } else {
            taxModeCol.style.visibility = 'visible';
            taxInputCol.style.visibility = 'visible';
            document.getElementById('rawAmountLabel').innerText = taxMode === '含稅' ? "金額 (含稅)" : "金額 (未稅)";

            if (taxMode === '含稅') {
                tax = isManualTax ? (parseFloat(taxInput.value) || 0) : Math.round(inputAmount - (inputAmount / 1.05));
                raw = inputAmount - tax;
                if (!isManualTax) taxInput.value = tax || "";
            } else {
                raw = inputAmount;
                tax = isManualTax ? (parseFloat(taxInput.value) || 0) : Math.round(raw * 0.05);
                if (!isManualTax) taxInput.value = tax || "";
            }
        }
        
        const total = raw + tax;
        const hasClean = document.getElementById('cleanCheck').checked;
        const cRate = parseFloat(document.getElementById('cleanRate').value) || 0;
        const cleanFee = hasClean ? Math.round(total * (cRate / 100)) : 0;
        const subtotal = total - cleanFee;
        const hasRetention = document.getElementById('retentionCheck').checked;
        const rRate = parseFloat(document.getElementById('retentionRate').value) || 0;
        let retention = hasRetention ? (isManualRetention ? (parseFloat(retentionInput.value) || 0) : Math.round(subtotal * (rRate / 100))) : 0;
        if(!isManualRetention) retentionInput.value = retention || "";
        
        const net = (subtotal - retention) + adj;
        lastCalcState = { raw, tax, total, cRate, cleanFee, subtotal, rRate, retention, adj, adjNote };
        document.getElementById('netAmount').value = net;
        renderFormula(net);
        renderDetail();
    }

    function renderFormula(currentNet) {
        let html = `<div>① 全額：${fmt.format(lastCalcState.raw)}${lastCalcState.tax > 0 ? ' + 稅' + fmt.format(lastCalcState.tax) : ''} = <strong>${fmt.format(lastCalcState.total)}</strong></div>`;
        if (lastCalcState.cleanFee !== 0) {
            html += `<div>② 清潔費(${lastCalcState.cRate}%)：${fmt.format(lastCalcState.total)} × ${lastCalcState.cRate}% = <strong>${fmt.format(lastCalcState.cleanFee)}</strong></div>`;
        }
        html += `<div class="subtotal-line">③ 小計：${fmt.format(lastCalcState.total)} - ${fmt.format(lastCalcState.cleanFee)} = <strong>${fmt.format(lastCalcState.subtotal)}</strong></div>`;
        let stepCount = 4;
        if (lastCalcState.retention !== 0) {
            html += `<div>④ 保留款：${fmt.format(lastCalcState.subtotal)} × ${lastCalcState.rRate}% = <strong>${fmt.format(lastCalcState.retention)}</strong></div>`;
            stepCount = 5;
        }
        if (lastCalcState.adj !== 0) {
            html += `<div>${stepCount === 5 ? '⑤' : '④'} ${lastCalcState.adjNote}：<strong>${lastCalcState.adj >= 0 ? '+' : ''}${fmt.format(lastCalcState.adj)}</strong></div>`;
            stepCount++;
        }
        html += `<div style="margin-top:5px; border-top:1px solid #EEE; padding-top:5px;">${stepCount === 6 ? '⑥' : (stepCount === 5 ? '⑤' : '④')} 淨額：<strong>${fmt.format(currentNet)}</strong></div>`;
        document.getElementById('processFormula').innerHTML = html;
    }

    function saveData() {
        const net = parseFloat(document.getElementById('netAmount').value) || 0;
        if (net <= 0 || !document.getElementById('p1Pct').value) { alert("請輸入金額與比例"); return; }
        const timestamp = Date.now();
        const saveMonthLabel = `${new Date().getFullYear()}.${(new Date().getMonth()+1).toString().padStart(2, '0')}`;
        const p1Pct = parseFloat(document.getElementById('p1Pct').value);
        const pay1 = Math.round(net * (p1Pct / 100));
        const workNote = document.getElementById('workNote').value || "工程";
        const currentBaseDate = document.getElementById('baseDate').value;

        const recordBase = { 
            company: document.getElementById('companySelect').value, 
            bank: document.getElementById('tempBankCode').value || "", 
            acc: document.getElementById('tempAccount').value || "", 
            owner: document.getElementById('tempOwner').value || "", 
            formula: document.getElementById('processFormula').innerHTML, 
            saveMonth: saveMonthLabel,
            settings: { p1Pct: document.getElementById('p1Pct').value, p1Mon: document.getElementById('p1Mon').value, p2Pct: document.getElementById('p2Pct').value, p2Mon: document.getElementById('p2Mon').value, baseDate: currentBaseDate } 
        };
        
        db.push({ ...recordBase, id: timestamp + "_1", date: getCalculatedDate(parseInt(document.getElementById('p1Mon').value || 0), false), desc: p1Pct < 100 ? `${workNote}(2-1)` : workNote, amount: pay1 });
        if (p1Pct < 100) { 
            db.push({ ...recordBase, id: timestamp + "_2", date: getCalculatedDate(parseInt(document.getElementById('p2Mon').value || 0), false), desc: `${workNote}(2-2)`, amount: net - pay1 }); 
        }
        localStorage.setItem('paymentRecords', JSON.stringify(db));
        alert("儲存成功");
        clearInputFields(currentBaseDate);
    }

    function searchVendor(val) {
        const resultsDiv = document.getElementById('searchResults');
        if (!val) { resultsDiv.style.display = 'none'; return; }
        const filtered = vendors.filter(v => v.name.includes(val) || v.owner.includes(val));
        if (filtered.length > 0) {
            resultsDiv.innerHTML = filtered.map(v => `
                <div class="search-item" onclick="selectVendor('${v.name}', '${v.bankCode}', '${v.account}', '${v.owner}')">
                    <div><strong>${v.name}</strong> (${v.owner})</div>
                </div>
            `).join('');
            resultsDiv.style.display = 'block';
        } else { resultsDiv.style.display = 'none'; }
    }

    function selectVendor(name, bank, acc, owner) {
        document.getElementById('vendorSearch').value = name;
        document.getElementById('tempBankCode').value = bank || "";
        document.getElementById('tempAccount').value = acc || "";
        document.getElementById('tempOwner').value = owner || "";
        document.getElementById('searchResults').style.display = 'none';
    }

    function getCalculatedDate(addMonths, useSlash = true) {
        const rawBase = document.getElementById('baseDate').value;
        if (!/^\d{7}$/.test(rawBase)) return "格式錯誤";
        let year = parseInt(rawBase.substring(0, 3)) + 1911;
        let month = parseInt(rawBase.substring(3, 5)) - 1;
        let day = parseInt(rawBase.substring(5, 7));
        let d = new Date(year, month, day);
        if (addMonths > 0) { d.setMonth(d.getMonth() + addMonths); d.setDate(15); }
        const resY = d.getFullYear() - 1911;
        const resM = (d.getMonth() + 1).toString().padStart(2, '0');
        const resD = d.getDate().toString().padStart(2, '0');
        return useSlash ? `${resY}/${resM}/${resD}` : `${resY}${resM}${resD}`;
    }

    function renderDetail() {
        const net = parseFloat(document.getElementById('netAmount').value) || 0;
        const p1Pct = parseFloat(document.getElementById('p1Pct').value) || 0;
        const pDetail = document.getElementById('paymentDetail');
        if(net <= 0 || isNaN(p1Pct)) { pDetail.innerHTML = ""; return; }
        const pay1 = Math.round(net * (p1Pct / 100));
        const date1 = getCalculatedDate(parseInt(document.getElementById('p1Mon').value || 0), true);
        let html = `<div class="section-title">付款排程 (預覽)</div><div class="date-line">${date1} &nbsp; $${fmt.format(pay1)}</div>`;
        if (p1Pct < 100) {
            html += `<div class="date-line">${getCalculatedDate(parseInt(document.getElementById('p2Mon').value || 0), true)} &nbsp; $${fmt.format(net - pay1)}</div>`;
        }
        pDetail.innerHTML = html;
    }

    function clearInputFields(keptBaseDate) {
        ['vendorSearch', 'workNote', 'rawAmount', 'taxAmount', 'retentionAmount', 'adjustmentNote', 'adjustmentAmount', 'netAmount'].forEach(id => {
            const el = document.getElementById(id); if(el) el.value = "";
        });
        document.getElementById('baseDate').value = keptBaseDate;
        document.getElementById('processFormula').innerHTML = "請輸入資料...";
        document.getElementById('paymentDetail').innerHTML = "";
    }

    function updateFormulaOnly() { renderFormula(parseFloat(document.getElementById('netAmount').value) || 0); renderDetail(); }

    function switchPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active');
        if(pageId === 'listPage') { initMonthFilter(); renderTable(); }
    }

    function initMonthFilter() {
        const months = new Set();
        db.forEach(item => { if(item.saveMonth) months.add(item.saveMonth); });
        const now = new Date();
        const currentLabel = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2, '0')}`;
        months.add(currentLabel);
        document.getElementById('filterMonth').innerHTML = `<option value="全部">全部月份</option>` + Array.from(months).sort().reverse().map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('filterMonth').value = currentLabel;
    }

    function initBaseDate() {
        const now = new Date();
        document.getElementById('baseDate').value = `${now.getFullYear() - 1911}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
    }

    function renderTable() {
        const filterComp = document.getElementById('filterCompany').value;
        const filterMon = document.getElementById('filterMonth').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        let counter = 1;
        const filtered = db.filter(item => (filterComp === "全部" || item.company === filterComp) && (filterMon === "全部" || item.saveMonth === filterMon));
        filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center;"><input type="checkbox" class="item-check" data-id="${item.id}" checked></td>
                <td style="text-align:center; color:#999;">${counter++}</td>
                <td>${item.date}</td>
                <td>${item.desc}</td>
                <td class="amount-cell">${fmt.format(item.amount)}</td>
                <td>${item.bank || ''}</td>
                <td>${item.acc || ''}</td>
                <td>${item.owner || ''}</td>
                <td>${item.company || ''}</td>
                <td class="action-cell"><button class="btn-del" onclick="deleteRecord('${item.id}')">×</button></td>
            `;
            tbody.appendChild(tr);
        });
        updateSummary();
    }

    function updateSummary() {
        const filterComp = document.getElementById('filterCompany').value;
        const filterMon = document.getElementById('filterMonth').value;
        const filtered = db.filter(item => (filterComp === "全部" || item.company === filterComp) && (filterMon === "全部" || item.saveMonth === filterMon));
        let sum = 0; filtered.forEach(i => sum += i.amount);
        document.getElementById('filteredTotal').innerText = '$' + fmt.format(sum);
        document.getElementById('checkedTotal').innerText = '$' + fmt.format(sum);
    }

    function deleteRecord(id) { if(confirm("確定刪除？")) { db = db.filter(i => i.id !== id); localStorage.setItem('paymentRecords', JSON.stringify(db)); renderTable(); } }

    window.onload = () => { setSelect('invType', lastSelection.invType); setSelect('taxMode', lastSelection.taxMode); initMonthFilter(); initBaseDate(); };
</script>

</body>
</html>
